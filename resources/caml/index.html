<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://crcresearch.github.io/ndcmsT3/resources/caml/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CAML - CMS Tier 3 at University of Notre Dame</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CAML";
        var mkdocs_page_input_path = "resources/caml.md";
        var mkdocs_page_url = "/ndcmsT3/resources/caml/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../images/cms_logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">HOME</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">RESOURCES</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../ndcms/">NDCMS</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">CAML</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#access-requirements">Access requirements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#resource-description">Resource description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-the-resource-on-campus">Using the resource on campus</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#jupyterhub-service">Jupyterhub service</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-requisites</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#instructions">Instructions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#htcondor-submission">HTCondor Submission</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#htcondor-submission-file">HTCondor submission file</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setting-up-the-tutorial-examples">Setting up the tutorial examples</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#tensorflow-example">Tensorflow example</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pytorch-example">Pytorch example</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#amber-example">Amber example</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#jax-example">JAX example:</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#deepsphere-example">DeepSphere example</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">APPLICATIONS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../apps/eft/">EFT</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../apps/dv5/">DV5</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CMS Tier 3 at University of Notre Dame</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">RESOURCES</li>
      <li class="breadcrumb-item active">CAML</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/crcresearch/ndcmsT3/edit/master/docs/resources/caml.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="caml">CAML</h1>
<p>This page contains information regarding the NSF funded Cyberinfrastructure to Accelerate Machine Learning (CAML) computing resource. CAML provides GPU resources for accelerating machine learning to the research community both locally at the University of Notre Dame and nationally through the Open Science Grid (OSG).</p>
<p>CAML physically hosts GPU resources suitable for accelerating the training of models from standard Deep Learning libraries. Configured for both interactive and batch access, CAML supports both small-scale explorations to large-scale discovery science.</p>
<h2 id="access-requirements">Access requirements</h2>
<p>In order for local users to access this resource, a CRC account and access to the Panasas (scratch) storage. Please, follow the links below for more information on how to obtain these:</p>
<ul>
<li>Obtaining a CRC account: <a href="https://docs.crc.nd.edu/new_user/obtain_account.html">https://docs.crc.nd.edu/new_user/obtain_account.html</a></li>
<li>Panasas storage: <a href="https://docs.crc.nd.edu/infrastructure/storage.html?highlight=scratch365#panasas-scratch-storage">https://docs.crc.nd.edu/infrastructure/storage.html?highlight=scratch365#panasas-scratch-storage</a></li>
</ul>
<p>Access through OSG can be done by signing up to OSG Connect: <a href="https://www.osgconnect.net">https://www.osgconnect.net</a> Note only 20% of resources are allocated via this method at this point.</p>
<h2 id="resource-description">Resource description</h2>
<p>The CAML GPU cluster is composed of:</p>
<p><strong>camlnd.crc.nd.edu (frontend / submit host)</strong></p>
<pre class="highlight"><code class="language-shell">- 17 Dual 12-cores Intel(R) Xeon(R) Gold 6226 CPU @ 2.70GHz, 192 GB of Memory, 400 GB Disk
  4 GPUs NVIDIA Quadro RTX 6000

- 2 Dual 12-cores  Intel(R) Xeon(R) Gold 6226 CPU @ 2.70GHz, 192 GB of Memory, 400 GB Disk
  4 GPUs NVIDIA Tesla V100-PCIE-32GB</code></pre>
<hr />
<h2 id="using-the-resource-on-campus">Using the resource on campus</h2>
<p>The university provides two different methods to access this resource: through a Jupyterhub service and via HTCondor.</p>
<p>The former allows users to start interactive <a href="https://jupyterhub.readthedocs.io/en/stable/">Jupyterhub</a> notebook sessions on CAML GPU resources. The latter (HTCondor) is a batch system that provides a job queueing mechanism, allowing the scheduling of multiple jobs to this resource in parallel.</p>
<hr />
<h2 id="jupyterhub-service">Jupyterhub service</h2>
<p>Use this method if you need to access a single GPU resource interactively, through notebook sessions from your browser.</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>From a remote location (e.g. off campus, etc.), one must <em>first</em> log into the VPN. More information is available in the section <code>off-campus-connect</code>.</p>
<h3 id="instructions">Instructions</h3>
<p>After you get an account in camlnd.crc.nd.edu, you can click on the URL below in order to user Jupyterhub with CAML resources. This will start jupyter notebooks inside the GPU nodes for a specific amount of time. At present, access to your AFS Home area is allowed in read-only mode, use /scratch365/\$USER to write files.</p>
<p><a href="https://camlnd.crc.nd.edu:9800/">https://camlnd.crc.nd.edu:9800/</a></p>
<ol>
<li>Use your campus credentials to log in.</li>
</ol>
<p><img alt="image" src="../../images/JupyterhubLogin.png" /></p>
<ol>
<li>Then, set the following parameters (note more demanding parameters may take longer to be scheduled, so please try to estimate the resources and time needed for your work as best as possible):</li>
</ol>
<blockquote>
<ul>
<li>GPUs: Number of GPUs for your application, up to 4. Default: 1</li>
<li>CPUs: Number of CPUs. Default: 1</li>
<li>Memory: Requested Memory (GB)</li>
<li>Runtime: Maximum wall clock time (in minutes) allowed for your notebook to run. Max: 24 hours, Default:2 hours.</li>
<li>Container: This will be the software environment needed for your application. Please, ask the CRC for help if you need an environment not listed here.</li>
</ul>
</blockquote>
<p><img alt="image" src="../../images/JupyterhubSpawner.png" /></p>
<ol>
<li>Finally, you can either run python notebooks or work directly in the terminal. You can try the pytorch notebook example with the pytorch container. Note your starting directory will be located on /scratch365/\$USER.</li>
</ol>
<p><img alt="image" src="../../images/JupyterhubNotebook.png" /></p>
<p>Please, refer to the <a href="https://jupyter-notebook.readthedocs.io/en/stable/examples/Notebook/Notebook%20Basics.html">jupyter-notebook documentation</a> for more information.</p>
<hr />
<h2 id="htcondor-submission">HTCondor Submission</h2>
<p>In order to use CAML resources, we require defining singularity images on PATHs. E.g.: Via cvmfs.</p>
<p>For example, the following Notre Dame image (available via CVMFS) supports TensorFlow, Keras and PyTorch:</p>
<pre class="highlight"><code class="language-shell">/cvmfs/singularity.opensciencegrid.org/notredamedulac/el7-tensorflow-pytorch:latest</code></pre>
<p>and it is built from: <a href="https://github.com/NDCMS/el7-tensorflow-gpu">https://github.com/NDCMS/el7-tensorflow-gpu</a></p>
<p>This section will show submission examples for different workflows, pointing to the specific Singularity images to handle the software environment dependencies.</p>
<h3 id="htcondor-submission-file">HTCondor submission file</h3>
<p>HTCondor needs a submission file, describing the resources needed, input files, log paths, container image location and executable to run. E.g.:</p>
<pre class="highlight"><code class="language-shell">executable = yourexecutable.sh

# Note if you use a subdirectory like logs, you need to create it beforehand
# E.g.: mkdir logs
Log    = logs/$(Cluster).log
Output = logs/$(Cluster)-$(Process).out
Error  = logs/$(Cluster)-$(Process).err

# Input files
# You can transfer files like this:
should_transfer_files = Yes
transfer_input_files = /some/path/input_file

# But if you are using /scratch365 and all your input files are present there, all worker nodes will have read/write access to it, so you can just use the scratch365 paths instead without transferring the input files and set the following instead:
should_transfer_files = IF_NEEDED

# Singularity image, for amber for example, it would be:
#+SingularityImage = "cvmfs/singularity.opensciencegrid.org/notredamedulac/amber:latest"

# Number of GPUs, Cpus and Memory to use
request_gpus   = 1
request_memory = 1 Gb
request_cpus   = 1

# Number of jobs to submit
Queue 1</code></pre>
<p>Please, refer to the <a href="https://docs.crc.nd.edu/resources/condor.html">HTCondor documentation</a> for more details on how to create a submission file.</p>
<h3 id="setting-up-the-tutorial-examples">Setting up the tutorial examples</h3>
<p>Once you log in into camlnd.crc.nd.edu, type:</p>
<pre class="highlight"><code class="language-shell">cd /scratch365/$USER
git clone https://github.com/ND-CRC/ndgputests
cd ndgputests</code></pre>
<p>Then, follow one of the examples below.</p>
<h4 id="tensorflow-example">Tensorflow example</h4>
<pre class="highlight"><code class="language-shell">$ condor_submit submit_tensorflow.jdl</code></pre>
<p>Output example:</p>
<pre class="highlight"><code class="language-shell">- Executing python TensorFlow matrix multiplication example
  2020-03-25 13:18:29.845113: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compil    ed to use: AVX2 AVX512F FMA
  2020-03-25 13:18:30.004982: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 0 with properties:
  name: Quadro RTX 6000 major: 7 minor: 5 memoryClockRate(GHz): 1.62
  pciBusID: 0000:2f:00.0
  totalMemory: 22.17GiB freeMemory: 22.00GiB
  2020-03-25 13:18:30.005161: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1511] Adding visible gpu devices: 0
  2020-03-25 13:18:30.570670: I tensorflow/core/common_runtime/gpu/gpu_device.cc:982] Device interconnect StreamExecutor with strength 1 edge matrix:
  2020-03-25 13:18:30.570757: I tensorflow/core/common_runtime/gpu/gpu_device.cc:988]      0
  2020-03-25 13:18:30.570794: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1001] 0:   N
  2020-03-25 13:18:30.570954: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1115] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU    :0 with 21320 MB memory) -&gt; physical GPU (device: 0, name: Quadro RTX 6000, pci bus id: 0000:2f:00.0, compute capability: 7.5)
  result of matrix multiplication
  ===============================
  [[ 1.0000000e+00  0.0000000e+00]
   [-4.7683716e-07  1.0000002e+00]]
  ===============================</code></pre>
<h4 id="pytorch-example">Pytorch example</h4>
<pre class="highlight"><code class="language-shell">$ condor_submit submit_pytorch.jdl</code></pre>
<p>Output example:</p>
<pre class="highlight"><code class="language-shell">- Executing python torch matrix multiplication example
--- Debug information ---
- torch version: 1.4.0
- GPU information:
-- CUDA Available: True
-- Number of devices: 1
-- CUDA Device Name: Quadro RTX 6000
-- Current CUDA device: 0
------
result of matrix multiplication
===============================
tensor([[ 1.0000e+00,  0.0000e+00],
        [-4.7684e-07,  1.0000e+00]], device='cuda:0')</code></pre>
<h4 id="amber-example">Amber example</h4>
<pre class="highlight"><code class="language-shell">$ condor_submit submit_amber.jdl</code></pre>
<p>Output example:</p>
<pre class="highlight"><code class="language-shell">- Entering scratch365 submit directory
- Executing pmemd.cuda
- Amber job is completed.
- Exit code: 0

# From mdout
|------------------- GPU DEVICE INFO --------------------
|
|            CUDA_VISIBLE_DEVICES: 0
|   CUDA Capable Devices Detected:      1
|           CUDA Device ID in use:      0
|                CUDA Device Name: Quadro RTX 6000
|     CUDA Device Global Mem Size:  22698 MB
| CUDA Device Num Multiprocessors:     72
|           CUDA Device Core Freq:   1.62 GHz
|
|--------------------------------------------------------</code></pre>
<h4 id="jax-example">JAX example:</h4>
<pre class="highlight"><code class="language-shell">$ condor_submit submit_jax.jdl</code></pre>
<p>Output example:</p>
<pre class="highlight"><code class="language-shell">- Executing python JAX matrix multiplication example
-----GPU devices information-----
[GpuDevice(id=0)]
GPU host id: 0
---------------------------------
Generate a random matrix
[[ 1.3890220e+00 -3.2292119e-01  1.5543443e-01 ...  1.6672333e-01
   1.0217550e+00  9.6981764e-02]
 [ 1.0637628e+00 -1.8089763e+00 -7.7909984e-02 ...  1.1778636e+00
  -4.3357372e-01 -2.7877533e-01]
 [-4.4029754e-01 -3.2537547e-01  2.7817255e-01 ...  6.8317270e-01
  -6.1108190e-01 -6.3071573e-01]
 ...
 [ 2.9218230e-01 -4.0055802e-01 -1.4978158e+00 ...  3.0673659e+00
  -1.1350130e+00  4.0964666e-01]
 [ 2.7635786e-01  1.5621810e-01  2.2997444e-03 ...  6.8930797e-02
  -4.0692501e-02  4.1683877e-01]
 [ 1.0231308e+00 -2.7423611e-01 -8.0369931e-01 ...  1.9415886e+00
   1.0946993e+00  2.1876085e+00]]
Multiply by its transpose:
result of matrix multiplication
=================================
[[2938.1716     17.38843    36.508224 ...   32.315964   51.31904
   -34.432022]
 [  17.38843  3031.179      41.194584 ...   47.24877    58.077858
   -13.371615]
 [  36.508224   41.194584 3000.4697   ...    8.109009  -42.50184
    26.49511 ]
 ...
 [  32.315964   47.24877     8.109009 ... 2916.339      34.381073
    39.404526]
 [  51.31904    58.077858  -42.50184  ...   34.381073 3032.2844
    63.69183 ]
 [ -34.432022  -13.371615   26.49511  ...   39.404526   63.69183
  3033.4866  ]] ] ] ] ] ]] ] ] ] ] ]]</code></pre>
<hr />
<h4 id="deepsphere-example">DeepSphere example</h4>
<pre class="highlight"><code class="language-shell">$ condor_submit submit_deepsphere.jdl</code></pre>
<p>Part of output example:</p>
<pre class="highlight"><code class="language-shell">emory) -&gt; physical GPU (device: 0, name: Quadro RTX 6000, pci bus id: 0000:2f:00.0, compute capability: 7.5)
2020-05-18 14:09:22.115326: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1639] Found device 0 with properties:
name: Quadro RTX 6000 major: 7 minor: 5 memoryClockRate(GHz): 1.62
pciBusID: 0000:2f:00.0
step 75 / 112 (epoch 8.00 / 12):
  learning_rate = 1.00e-01, training loss = 3.12e-03
  validation accuracy: 100.00 (50 / 50), f1 (weighted): 100.00, loss: 1.38e+00
  CPU time: 10s, wall time: 11s
step 90 / 112 (epoch 9.60 / 12):
  learning_rate = 1.00e-01, training loss = 5.68e-03
  validation accuracy: 100.00 (50 / 50), f1 (weighted): 100.00, loss: 1.41e+00
  CPU time: 11s, wall time: 12s
step 105 / 112 (epoch 11.20 / 12):
  learning_rate = 1.00e-01, training loss = 2.04e-03
  validation accuracy: 100.00 (50 / 50), f1 (weighted): 100.00, loss: 1.44e+00
  CPU time: 12s, wall time: 13s
step 112 / 112 (epoch 11.95 / 12):
  learning_rate = 1.00e-01, training loss = 1.00e-03
  validation accuracy: 100.00 (50 / 50), f1 (weighted): 100.00, loss: 1.44e+00
  CPU time: 13s, wall time: 14s
validation accuracy: best = 100.00, mean = 100.00</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ndcms/" class="btn btn-neutral float-left" title="NDCMS"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../apps/eft/" class="btn btn-neutral float-right" title="EFT">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/crcresearch/ndcmsT3" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../ndcms/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../apps/eft/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
